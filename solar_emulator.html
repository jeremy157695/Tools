<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>åœ°åœ–é»é¸æŸ¥è©¢ GHI + 360åº¦æ¡¶å‹æ¥æ”¶èƒ½é‡</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            margin-bottom: 10px;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #result {
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 10px;
            max-height: 350px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <h2>åœ°åœ–é»é¸æŸ¥è©¢ GHI + 360åº¦æ¡¶å‹æ¥æ”¶èƒ½é‡</h2>
    <p>é»é¸åœ°åœ–å–å¾—ç·¯ç¶“åº¦ï¼Œè¼¸å…¥æ—¥æœŸï¼Œè¨ˆç®—å…¨å¤© GHI åŠå‚ç›´360åº¦æ¡¶å‹é¢æ¥æ”¶èƒ½é‡</p>

    <label>æ—¥æœŸ (YYYYMMDD)ï¼š<input type="text" id="date" value="20240601" /></label>
    <div id="map"></div>

    <div><b>é¸å–ä½ç½®ï¼š</b> ç·¯åº¦ <span id="lat">-</span>ï¼Œç¶“åº¦ <span id="lng">-</span></div>

    <button id="btnQuery" disabled>æŸ¥è©¢ GHI èˆ‡æ¡¶å‹æ¥æ”¶èƒ½é‡</button>

    <pre id="result"></pre>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // åº¦è½‰å¼§åº¦
        function deg2rad(deg) { return deg * Math.PI / 180; }
        // å¼§åº¦è½‰åº¦
        function rad2deg(rad) { return rad * 180 / Math.PI; }

        // æ¨¡æ“¬ GHI å‡½æ•¸ï¼ˆå³°å€¼1000 W/mÂ²ï¼Œ6-18é»ï¼‰
        function estimateGHI(hour) {
            if (hour < 6 || hour > 18) return 0;
            return 1000 * Math.sin(Math.PI * (hour - 6) / 12);
        }

        // å¤ªé™½é«˜åº¦è§’è¨ˆç®—ï¼Œç°¡åŒ–ç‰ˆæœ¬ï¼ˆåœ°å¿ƒå¤ªé™½ä½ç½®ï¼‰
        // è¼¸å…¥ï¼šç·¯åº¦, ç¶“åº¦, æ—¥æœŸç‰©ä»¶(UTCæ™‚é–“)
        // è¼¸å‡ºï¼šé«˜åº¦è§’(åº¦)
        function solarAltitude(lat, lng, dateObj) {
            function daysSinceJ2000(date) {
                const J2000 = new Date(Date.UTC(2000, 0, 1, 12, 0, 0));
                return (date.getTime() - J2000.getTime()) / 86400000;
            }

            const D = daysSinceJ2000(dateObj);

            const g = (357.529 + 0.98560028 * D) % 360;
            const q = (280.459 + 0.98564736 * D) % 360;
            const L = (q + 1.915 * Math.sin(deg2rad(g)) + 0.020 * Math.sin(2 * deg2rad(g))) % 360;
            const e = 23.439 - 0.00000036 * D;

            const sinDec = Math.sin(deg2rad(e)) * Math.sin(deg2rad(L));
            const dec = Math.asin(sinDec);

            // *** ä¿®æ­£æ™‚è§’éƒ¨åˆ† ***
            const timezone = Math.round(lng / 15);

            const timeUTC = dateObj.getUTCHours() + dateObj.getUTCMinutes() / 60;
            const localSolarTime = timeUTC + (lng / 15) - timezone;

            const H = deg2rad(15 * (localSolarTime - 12));

            const latRad = deg2rad(lat);

            const altitude = Math.asin(
                Math.sin(latRad) * Math.sin(dec) +
                Math.cos(latRad) * Math.cos(dec) * Math.cos(H)
            );

            return rad2deg(altitude);
        }


        // åˆå§‹åŒ– Leaflet åœ°åœ–
        const map = L.map('map').setView([24.96, 121.46], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        let selectedLat = null;
        let selectedLng = null;
        let marker = null;

        map.on('click', (e) => {
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;

            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([selectedLat, selectedLng]).addTo(map);

            document.getElementById('lat').textContent = selectedLat.toFixed(5);
            document.getElementById('lng').textContent = selectedLng.toFixed(5);

            document.getElementById('btnQuery').disabled = false;
            document.getElementById('result').textContent = '';
        });

        document.getElementById('btnQuery').addEventListener('click', () => {
            const dateStr = document.getElementById('date').value;
            if (!dateStr.match(/^\d{8}$/)) {
                alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ YYYYMMDD');
                return;
            }
            if (selectedLat === null || selectedLng === null) {
                alert('è«‹å…ˆåœ¨åœ°åœ–ä¸Šé»é¸ä½ç½®');
                return;
            }

            const year = parseInt(dateStr.substr(0, 4));
            const month = parseInt(dateStr.substr(4, 2)) - 1;
            const day = parseInt(dateStr.substr(6, 2));

            let output = `ğŸ“… æ—¥æœŸï¼š${dateStr}\nğŸ“ ä½ç½®ï¼šç·¯åº¦ ${selectedLat.toFixed(5)}ï¼Œç¶“åº¦ ${selectedLng.toFixed(5)}\n\n`;
            output += 'æ™‚åˆ»\tGHI(W/mÂ²)\tå¤ªé™½é«˜åº¦(Â°)\tæ¡¶å‹æ¥æ”¶(W/mÂ²)\n';

            let totalGHI = 0;
            let totalBucket = 0;

            for (let h = 0; h < 24; h++) {
                const dateObj = new Date(Date.UTC(year, month, day, h, 0, 0));
                const ghi = estimateGHI(h);
                const alt = solarAltitude(selectedLat, selectedLng, dateObj);
                // æ¡¶å‹æ¥æ”¶ç”¨ cos(å¤ªé™½é«˜åº¦è§’)
                const bucketEnergy = ghi > 0 && alt > 0 ? ghi * Math.cos(deg2rad(alt)) : 0;

                totalGHI += ghi;
                totalBucket += bucketEnergy;

                output += `${h.toString().padStart(2, '0')}:00\t${ghi.toFixed(1)}\t\t${alt.toFixed(1)}\t\t${bucketEnergy.toFixed(1)}\n`;
            }
            output += `\nå…¨å¤©ç¸½ GHIï¼š${totalGHI.toFixed(1)} W/mÂ²\nå…¨å¤©æ¡¶å‹æ¥æ”¶ç¸½é‡ï¼š${totalBucket.toFixed(1)} W/mÂ²\n`;

            document.getElementById('result').textContent = output;
        });
    </script>
</body>

</html>