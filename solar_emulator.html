<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>模擬日照強度</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstz@2.1.1/dist/jstz.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        #map {
            height: 400px;
            margin-bottom: 1em;
        }

        canvas {
            max-width: 800px;
        }
    </style>
</head>

<body>
    <h2>☀️ 模擬 GHI（垂直面板）</h2>

    <div id="map"></div>

    <label>選擇日期：<input type="date" id="dateInput"></label>
    <button onclick="simulate()">模擬</button>

    <p id="totalEnergy"></p>

    <canvas id="chart"></canvas>

    <!-- 改成表格來放資料 -->
    <table id="hourlyTable" border="1" style="border-collapse: collapse; max-width:800px; margin-top:1em;">
        <thead>
            <tr>
                <th>時刻</th>
                <th>GHI (水平面) W/m²</th>
                <th>桶型垂直面板 W/m²</th>
            </tr>
        </thead>
        <tbody>
            <!-- JS 會動態產生資料列 -->
        </tbody>
    </table>

    <script>
        let lat = 25.0330, lon = 121.5654;
        const map = L.map('map').setView([lat, lon], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const marker = L.marker([lat, lon]).addTo(map);

        map.on('click', (e) => {
            lat = e.latlng.lat;
            lon = e.latlng.lng;
            marker.setLatLng(e.latlng);
        });

        document.getElementById("dateInput").valueAsDate = new Date();

        function getTimeZoneOffsetInHours(date, lat, lon) {
            return -date.getTimezoneOffset() / 60;
        }

        function simulate() {
            const dateStr = document.getElementById("dateInput").value;
            const localDate = new Date(dateStr);
            const offsetHours = getTimeZoneOffsetInHours(localDate, lat, lon);

            const times = [];
            const ghi = [];
            const ghiCylindrical = [];
            let totalWh = 0;
            let totalWhCyl = 0;

            for (let h = 0; h < 24; h++) {
                const localHour = h;
                const utcHour = h - offsetHours;
                const d = new Date(Date.UTC(localDate.getFullYear(), localDate.getMonth(), localDate.getDate(), utcHour));

                const pos = SunCalc.getPosition(d, lat, lon);
                const alt = pos.altitude; // 太陽高度角 (radians)

                const MAX_GHI = 1100;
                const ghiRaw = Math.max(0, Math.sin(alt)) * MAX_GHI;
                ghi.push(Math.round(ghiRaw));
                totalWh += ghiRaw;

                const cosine = Math.max(0, Math.cos(alt));
                const cylVal = ghiRaw * cosine;
                ghiCylindrical.push(Math.round(cylVal));
                totalWhCyl += cylVal;

                times.push(localHour + ':00');
            }

            document.getElementById("totalEnergy").innerText =
                `模擬結果：\n總 GHI ≈ ${totalWh.toFixed(0)} Wh/m²；桶型垂直面板接收 ≈ ${totalWhCyl.toFixed(0)} Wh/m²`;

            // 將資料塞進表格
            const tbody = document.querySelector('#hourlyTable tbody');
            tbody.innerHTML = ''; // 清空舊資料
            for (let i = 0; i < times.length; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:center;">${times[i]}</td>
                    <td style="text-align:center;">${ghi[i]}</td>
                    <td style="text-align:center;">${ghiCylindrical[i]}</td>
                `;
                tbody.appendChild(tr);
            }

            drawChart(times, ghi, ghiCylindrical);
        }




        let chart;
        function drawChart(labels, ghiData, verticalData) {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'GHI (水平面)',
                            data: ghiData,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0,0,255,0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '垂直面板接收量',
                            data: verticalData,
                            borderColor: 'orange',
                            backgroundColor: 'rgba(255,165,0,0.2)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'W/m²' } },
                        x: { title: { display: true, text: '當地時間（小時）' } }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `模擬 GHI 與垂直面板接收量 @ (${lat.toFixed(4)}, ${lon.toFixed(4)})`
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>
